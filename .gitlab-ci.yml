# CI Execution Control
# 
# This pipeline executes heavy benchmark processing, so we implement controls to avoid unnecessary executions.
#
# CI Control Method:
# - File-based automatic skip: Skip CI when only specific files are changed
#   Effect: Pipeline is created but jobs are skipped based on file changes
#
# Files that automatically skip CI:
# - README.md, ADD_APP.md (documentation)
# - result_server/templates/*.html (web templates)
# - .kiro/**/* (Kiro configuration)
# - .vscode/**/* (VSCode settings)
#
# Important Notes:
# - trigger_child_pipeline depends on generate_matrix, so we use needs: optional: true
# - This prevents trigger_child_pipeline from failing when generate_matrix is skipped
# - Both jobs use the same rules to maintain consistency

stages:
  - generate
  - trigger
  - benchpark_generate
  - benchpark_trigger

variables:
  code: ""
  system: ""
  benchpark: "false"

# Extract system and code filters from API variables or commit message
.filters: &filters
  - |
    # Priority 1: API trigger variables (from curl -F "variables[system]=...")
    if [[ -n "$system" ]]; then
      echo "System filter from API variable: $system"
    else
      # Extract from commit message using sed
      system_match=$(echo "$CI_COMMIT_MESSAGE" | sed -n 's/.*\[system:\([^]]*\)\].*/\1/p')
      if [[ -n "$system_match" ]]; then
        export system="$system_match"
        echo "System filter from commit message: $system"
      else
        echo "No system filter detected, running all systems"
      fi
    fi
  - |
    # Priority 1: API trigger variables (from curl -F "variables[code]=...")
    if [[ -n "$code" ]]; then
      echo "Code filter from API variable: $code"
    else
      # Extract from commit message using sed
      code_match=$(echo "$CI_COMMIT_MESSAGE" | sed -n 's/.*\[code:\([^]]*\)\].*/\1/p')
      if [[ -n "$code_match" ]]; then
        export code="$code_match"
        echo "Code filter from commit message: $code"
      else
        echo "No code filter detected, running all programs"
      fi
    fi

generate_matrix:
  stage: generate
  before_script:
    *filters
  script:
    - bash ./scripts/matrix_generate.sh code=$code system=$system
  tags:
    - general
  artifacts:
    paths:
      - .gitlab-ci.generated.yml
    expire_in: 1 hour
  rules:
    - changes:
        - ".gitlab-ci.yml"
        - ".github/workflows/*.yml"
        - "programs/**/*"
        - "scripts/**/*"
        - "system.csv"
        - "queue.csv"
      when: always
    - changes:
        - "README.md"
        - "ADD_APP.md"
        - "result_server/templates/*.html"
        - ".kiro/**/*"
        - ".vscode/**/*"
      when: never
    - when: always

trigger_child_pipeline:
  stage: trigger
  trigger:
    include:
      - artifact: .gitlab-ci.generated.yml
        job: generate_matrix
    strategy: depend
  needs:
    - job: generate_matrix
      optional: true
  rules:
    - changes:
        - ".gitlab-ci.yml"
        - ".github/workflows/*.yml"
        - "programs/**/*"
        - "scripts/**/*"
        - "system.csv"
        - "queue.csv"
      when: always
    - changes:
        - "README.md"
        - "ADD_APP.md"
        - "result_server/templates/*.html"
        - ".kiro/**/*"
        - ".vscode/**/*"
      when: never
    - when: always
# BenchPark Monitor Jobs
generate_benchpark_matrix:
  stage: benchpark_generate
  script:
    - bash ./scripts/benchpark_matrix_generate.sh system=$system
  tags:
    - general
  artifacts:
    paths:
      - .gitlab-ci.benchpark.yml
    expire_in: 1 hour
  rules:
    - if: '$benchpark == "true"'
      when: always
    - if: '$CI_COMMIT_MESSAGE =~ /\[benchpark\]/'
      when: always
    - changes:
        - "config/benchpark-monitor/**/*"
        - "scripts/benchpark_*"
        - "BENCHPARK_MONITOR.md"
      when: always
    - when: never

trigger_benchpark_pipeline:
  stage: benchpark_trigger
  trigger:
    include:
      - artifact: .gitlab-ci.benchpark.yml
        job: generate_benchpark_matrix
    strategy: depend
  needs:
    - job: generate_benchpark_matrix
      optional: true
  rules:
    - if: '$benchpark == "true"'
      when: always
    - if: '$CI_COMMIT_MESSAGE =~ /\[benchpark\]/'
      when: always
    - changes:
        - "config/benchpark-monitor/**/*"
        - "scripts/benchpark_*"
        - "BENCHPARK_MONITOR.md"
      when: always
    - when: never