# CI Execution Control
# 
# This pipeline executes heavy benchmark processing, so we implement controls to avoid unnecessary executions.
#
# CI Control Methods:
# 1. [skip ci] - Skip entire pipeline (most reliable)
#    Example: git commit -m "Fix documentation [skip ci]"
#    Effect: GitLab does not create the pipeline at all, completely skipped
#
# 2. rules-based individual job control - Skip only when specific files are changed
#    Effect: Pipeline is created but individual jobs are skipped based on conditions
#
# Files that automatically skip CI:
# - README.md, ADD_APP.md (documentation)
# - result_server/templates/*.html (web templates)
# - .kiro/**/* (Kiro configuration)
# - .vscode/**/* (VSCode settings)
#
# Important Notes:
# - trigger_child_pipeline depends on generate_matrix, so we use needs: optional: true
# - This prevents trigger_child_pipeline from failing when generate_matrix is skipped
# - Both jobs use the same rules to maintain consistency

stages:
  - generate
  - trigger

variables:
  code: ""
  system: ""

generate_matrix:
  stage: generate
  script:
    - bash ./scripts/matrix_generate.sh code=$code system=$system
  tags:
    - general
  artifacts:
    paths:
      - .gitlab-ci.generated.yml
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[skip ci\]/
      when: never
    - changes:
        - "README.md"
        - "ADD_APP.md"
        - "result_server/templates/*.html"
        - ".kiro/**/*"
        - ".vscode/**/*"
      when: never
    - when: always

trigger_child_pipeline:
  stage: trigger
  trigger:
    include:
      - artifact: .gitlab-ci.generated.yml
        job: generate_matrix
    strategy: depend
  needs:
    - job: generate_matrix
      optional: true
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[skip ci\]/
      when: never
    - changes:
        - "README.md"
        - "ADD_APP.md"
        - "result_server/templates/*.html"
        - ".kiro/**/*"
        - ".vscode/**/*"
      when: never
    - when: always
